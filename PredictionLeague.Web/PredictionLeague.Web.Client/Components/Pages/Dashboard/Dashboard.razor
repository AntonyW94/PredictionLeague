@using PredictionLeague.Web.Client.Services.Dashboard

@page "/dashboard"

@attribute [Authorize]
@inject IDashboardStateService DashboardState
@implements IAsyncDisposable

<svg style="width:0;height:0;position:absolute;visibility:hidden;" aria-hidden="true" focusable="false">
    <defs>
        <linearGradient id="grad-gold" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#C9B037" />
            <stop offset="40%" stop-color="#F2E29F" /> <stop offset="60%" stop-color="#AA8825" />
            <stop offset="100%" stop-color="#7A631A" />
        </linearGradient>

        <linearGradient id="grad-silver" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#9CA3AF" />
            <stop offset="40%" stop-color="#F9FAFB" /> <stop offset="60%" stop-color="#6B7280" />
            <stop offset="100%" stop-color="#374151" />
        </linearGradient>

        <linearGradient id="grad-bronze" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#8B5A2B" />
            <stop offset="40%" stop-color="#EBCBA6" /> <stop offset="60%" stop-color="#8B5A2B" />
            <stop offset="100%" stop-color="#5C3A1A" />
        </linearGradient>

        <linearGradient id="grad-blue" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#3B82F6" />
            <stop offset="40%" stop-color="#93C5FD" /> <stop offset="60%" stop-color="#2563EB" />
            <stop offset="100%" stop-color="#1E40AF" />
        </linearGradient>

        <linearGradient id="grad-red" x1="20%" y1="0%" x2="80%" y2="100%">
            <stop offset="0%" stop-color="#EF4444" />
            <stop offset="40%" stop-color="#FCA5A5" /> <stop offset="60%" stop-color="#B91C1C" />
            <stop offset="100%" stop-color="#7F1D1D" />
        </linearGradient>

        <linearGradient id="rim-gold" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#FFF8D1" /> <stop offset="100%" stop-color="#C9B037" />
        </linearGradient>

        <linearGradient id="rim-silver" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#FFFFFF" />
            <stop offset="100%" stop-color="#9CA3AF" />
        </linearGradient>

        <linearGradient id="rim-bronze" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#FFE8CC" />
            <stop offset="100%" stop-color="#A67C52" />
        </linearGradient>

        <linearGradient id="rim-blue" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#E0F2FE" />
            <stop offset="100%" stop-color="#3B82F6" />
        </linearGradient>

        <linearGradient id="rim-red" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#FEE2E2" />
            <stop offset="100%" stop-color="#EF4444" />
        </linearGradient>

        <filter id="shield-shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="2" stdDeviation="1.5" flood-color="#000" flood-opacity="0.5" />
        </filter>
    </defs>
</svg>

<PageTitle>Dashboard</PageTitle>

<AuthorizeView>
    <Authorizing>
        <div class="app-loading-container">
            <div class="spinner"></div>
            <p>Authorising...</p>
        </div>
    </Authorizing>
    <Authorized>
        <div class="page-container">
            <div class="dashboard-container">
                <div class="row align-items-stretch">
                    <div class="col-lg-8">
                        <div class="row">
                            <div class="col-lg-12 mb-4">
                                <UpcomingRoundsTile />
                            </div>
                        </div>

                        <div class="row">
                            @{
                                var showAvailableLeagues = DashboardState.IsAvailableLeaguesLoading || DashboardState.AvailableLeagues.Any() || DashboardState.HasAvailablePrivateLeagues;
                                var myLeaguesClass = showAvailableLeagues ? "col-lg-6 mb-4 mb-md-0" : "col-lg-12 mb-4 mb-lg-0";
                            }

                            <div class="@myLeaguesClass">
                                <MyLeaguesTile />
                            </div>

                            @if (showAvailableLeagues)
                            {
                                <div class="col-lg-6 mb-4 mb-md-0">
                                    <AvailableLeaguesTile />
                                </div>
                            }
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <LeaderboardsTile />
                    </div>
                </div>
            </div>
        </div>
    </Authorized>
</AuthorizeView>

@code {
    protected override async Task OnInitializedAsync()
    {
        DashboardState.OnStateChange += StateHasChanged;

        await Task.WhenAll(
            DashboardState.LoadMyLeaguesAsync(),
            DashboardState.LoadAvailableLeaguesAsync(),
            DashboardState.LoadLeaderboardsAsync(),
            DashboardState.LoadUpcomingRoundsAsync()
        );
    }

    public ValueTask DisposeAsync()
    {
        DashboardState.OnStateChange -= StateHasChanged;
        return ValueTask.CompletedTask;
    }
}