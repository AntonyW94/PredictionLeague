@inject NavigationManager NavigationManager
@inject IDashboardStateService DashboardState
@inject IJSRuntime JsRuntime

@using PredictionLeague.Domain.Common.Enumerations
@using PredictionLeague.Web.Client.Services.Dashboard

@implements IAsyncDisposable

<div class="card h-100">
    <h3 class="text-white text-center fw-bold mb-4">My Leagues</h3>

    <ApiError Message="@DashboardState.MyLeaguesErrorMessage" />

    @if (DashboardState.IsMyLeaguesLoading)
    {
        <p class="text-center text-white"><em>Loading my leagues...</em></p>
    }
    else if (!DashboardState.MyLeagues.Any())
    {
        <p class="text-center text-white">You haven't joined any leagues yet.</p>
    }
    else
    {
        <div class="card-grid">
            @foreach (var league in DashboardState.MyLeagues)
            {
                <div class="action-card light">
                    <div class="card-header">
                        <h5 class="fw-bold text-white">@league.Name</h5>
                        <small class="text-white-50">@league.SeasonName</small>
                    </div>

                    <div class="action-card-body">
                        @switch (league.Status)
                        {
                            case LeagueMemberStatus.Approved:
                            {
                                <div class="action-card-row">
                                    <div class="badge-group badge-group--green">
                                        <span class="badge-icon" title="Approved"><i class="bi bi-check-lg"></i></span>
                                        <span>Approved</span>
                                    </div>

                                    @if (league.Rank.HasValue && league.MemberCount.HasValue)
                                    {
                                        var statusPillClass = league.Rank switch
                                        {
                                            1 => "badge-group--gold",
                                            2 => "badge-group--silver",
                                            3 => "badge-group--bronze",
                                            _ => "badge-group--blue"
                                        };

                                        <div class="badge-group @statusPillClass ms-4">
                                            <span class="badge-icon" title="Rank"><i class="bi bi-trophy-fill"></i></span>
                                            <div class="position-info">
                                                <span>@league.Rank</span>
                                                <span> / @league.MemberCount</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                                break;
                            }

                            case LeagueMemberStatus.Pending:
                                <div class="action-card-row action-card-row--centered">
                                    <div class="badge-group badge-group--purple">
                                        <span class="badge-icon" title="Pending Approval"><i class="bi bi-clock-fill"></i></span>
                                        <span>Pending Approval</span>
                                    </div>
                                </div>
                                break;

                            case LeagueMemberStatus.Rejected:
                                <div class="action-card-row action-card-row--centered">
                                    <div class="badge-group badge-group--red">
                                        <span class="badge-icon" title="Rejected"><i class="bi bi-x-lg"></i></span>
                                        <span>Rejected by Admin</span>
                                    </div>
                                </div>
                                break;
                            
                            default:
                                throw new ArgumentOutOfRangeException();
                        }
                    </div>

                    <div class="action-card-footer">
                        @if (league.Status == LeagueMemberStatus.Rejected)
                        {
                            <button class="btn btn-sm red-button w-100" @onclick="() => HandleRemoveLeagueAsync(league.Id, league.Name)" disabled="@DashboardState.IsMyLeaguesLoading">
                                Remove
                            </button>
                        }
                        else
                        {
                            var canViewDashboard = league.Status == LeagueMemberStatus.Approved;
                            <button class="btn btn-sm @(canViewDashboard ? "purple-accent-button" : "grey-button") w-100"
                                    disabled="@(!canViewDashboard)"
                                    title="@(canViewDashboard ? "View League Dashboard" : "Unavailable until approved by the league admin")"
                                    @onclick="() => ViewLeagueDashboard(league.Id)">
                                View
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        DashboardState.OnStateChange += StateHasChanged;

        if (!DashboardState.MyLeagues.Any())
            await DashboardState.LoadMyLeaguesAsync();
    }

    private void ViewLeagueDashboard(int leagueId)
    {
        NavigationManager.NavigateTo($"/leagues/{leagueId}/dashboard");
    }

    private async Task HandleRemoveLeagueAsync(int leagueId, string leagueName)
    {
        var confirmed = await JsRuntime.InvokeAsync<bool>("blazorInterop.showConfirm",
            new object[] { $"Remove '{leagueName}'?", "This will remove the rejected league from your dashboard.", "Yes, Remove It", "Cancel" });

        if (confirmed)
            await DashboardState.RemoveRejectedLeagueAsync(leagueId);
    }

    public ValueTask DisposeAsync()
    {
        DashboardState.OnStateChange -= StateHasChanged;
        return ValueTask.CompletedTask;
    }
}