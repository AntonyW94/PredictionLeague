@page "/admin/seasons/{SeasonId:int}/rounds"

@attribute [Authorize(Roles = RoleNames.Administrator)]

@inject HttpClient Http
@inject NavigationManager NavigationManager

@using PredictionLeague.Contracts.Admin.Rounds
@using PredictionLeague.Domain.Common.Enumerations

<PageTitle>Manage Rounds</PageTitle>

<div class="page-container">
    <div class="admin-table-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-white mb-0">Manage Rounds</h3>
            <button class="btn d-flex align-items-center green-button" @onclick="AddRound">
                <span class="bi bi-plus-circle-fill"></span>
                <span class="d-none d-md-inline ms-2">Add Round</span>
            </button>
        </div>

        <ApiError Message="@_errorMessage" />
        <ApiSuccess Message="@_successMessage" />

        @if (_rounds == null && string.IsNullOrEmpty(_errorMessage))
        {
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (_rounds?.Any() == false)
        {
            <p class="text-center text-white">No rounds have been created for this season yet.</p>
        }
        else if (_rounds != null)
        {
            <div class="card-grid">
                @foreach (var round in _rounds)
                {
                    <div class="action-card light">
                        <div class="card-header">
                            <h5 class="fw-bold text-white mb-0">Round @round.RoundNumber</h5>
                        </div>
                        <div class="action-card-body">
                            <dl class="mb-0">
                                <div class="action-card-row">
                                    <dt>Start Date</dt>
                                    <dd>@round.StartDate.ToString("dd MMM yyyy")</dd>
                                </div>

                                <div class="action-card-row">
                                    <dt>Deadline</dt>
                                    <dd>@round.Deadline.ToString("dd MMM, HH:mm")</dd>
                                </div>

                                <div class="action-card-row">
                                    <dt>Status</dt>
                                    <dd>@round.Status.GetDescription()</dd>
                                </div>

                                <div class="action-card-row">
                                    <dt>Matches</dt>
                                    <dd>@round.MatchCount</dd>
                                </div>
                            </dl>
                        </div>

                        <div class="action-card-footer">
                            <button class="btn green-button flex-grow-1" @onclick="() => EditRound(round.Id)">
                                <span class="bi bi-pencil-fill me-2"></span>Edit
                            </button>

                            @if (round.Id == _firstPublishedRoundId && round.AllPredictionsIn)
                            {
                                <button class="btn grey-button" disabled>
                                    <span class="bi bi-envelope-fill me-2"></span>Send Chase Emails
                                </button>
                            }
                            else if (round.Id == _firstPublishedRoundId && !_isChasing)
                            {
                                <button class="btn purple-accent-button" @onclick="() => SendChaseEmails(round.Id)">
                                    <span class="bi bi-envelope-fill me-2"></span>Send Chase Emails
                                </button>
                            }
                            else if (round.Id == _firstPublishedRoundId && _isChasing)
                            {
                                <button class="btn purple-accent-button" disabled>
                                    <span class="spinner-border spinner-border-s me-2" role="status" aria-hidden="true"></span>Sending...
                                </button>
                            }

                            <button class="btn blue-light-button flex-grow-1" @onclick="() => EnterResults(round.Id)">
                                <span class="bi bi-clipboard2-check-fill me-2"></span>Enter Results
                            </button>
                        </div>
                    </div>
                }
            </div>
        }

        <div class="mt-4">
            <button class="btn red-button d-flex align-items-center" @onclick="Back">
                <span class="bi bi-arrow-left-circle-fill me-2"></span>Back to Season
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public int SeasonId { get; set; }
    private List<RoundWithAllPredictionsInDto>? _rounds;
    private string? _errorMessage;
    private string? _successMessage;
    private int? _firstPublishedRoundId;
    private bool _isChasing;

    protected override async Task OnInitializedAsync()
    {
        _errorMessage = null;
        _successMessage = null;

        try
        {
            _rounds = await Http.GetFromJsonAsync<List<RoundWithAllPredictionsInDto>>($"api/admin/rounds/by-season/{SeasonId}");

            if (_rounds != null)
                _firstPublishedRoundId = _rounds.OrderBy(r => r.Deadline).FirstOrDefault(r => r.Status == RoundStatus.Published)?.Id;

        }
        catch (Exception)
        {
            _errorMessage = "An error occurred while loading the rounds for this season.";
        }
    }

    private async Task SendChaseEmails(int roundId)
    {
        _isChasing = true;

        StateHasChanged();

        var response = await Http.PostAsync($"api/admin/rounds/{roundId}/send-prediction-reminder-emails", null);

        if (response.IsSuccessStatusCode)
            _successMessage = $"Chase emails sent successfully for Round {roundId}";
        else
            _errorMessage = "Failed to send chase emails.";

        _isChasing = false;

        StateHasChanged();
    }

    private void AddRound() => NavigationManager.NavigateTo($"/admin/seasons/{SeasonId}/rounds/create");
    private void EditRound(int roundId) => NavigationManager.NavigateTo($"/admin/rounds/edit/{roundId}");
    private void Back() => NavigationManager.NavigateTo($"/admin/seasons/edit/{SeasonId}");
    private void EnterResults(int roundId) => NavigationManager.NavigateTo($"/admin/rounds/{roundId}/results");
}