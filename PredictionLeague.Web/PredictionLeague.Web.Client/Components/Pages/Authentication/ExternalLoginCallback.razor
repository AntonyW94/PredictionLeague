@page "/authentication/external-login-callback"

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<ExternalLoginCallback> Logger

@attribute [AllowAnonymous]

<div class="page-container">
    <div class="text-center text-white">
        <h3>Finalizing login...</h3>
        <div class="app-loading-container">
            <div class="spinner"></div>
            <p>This should only take a moment.</p>
        </div>
    </div>
</div>
@code {
    [SupplyParameterFromQuery] public string? RefreshToken { get; set; }
    [SupplyParameterFromQuery] public string? Source { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var sourcePage = string.IsNullOrEmpty(Source) ? "login" : Source;
        var failureUrl = $"/authentication/{sourcePage}?error=External login failed. Please try again.";

        if (!string.IsNullOrEmpty(RefreshToken))
        {
            var result = await ((ApiAuthenticationStateProvider)AuthStateProvider).LoginWithRefreshToken(RefreshToken);
            if (result)
            {
                NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            }
            else
            {
                NavigationManager.NavigateTo(failureUrl);
            }
        }
        else
        {
            Logger.LogWarning("FAILURE: 'token' query parameter NOT found in external login callback.");
            NavigationManager.NavigateTo(failureUrl);
        }
    }

}
