@page "/authentication/external-login-callback"

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

@attribute [AllowAnonymous]

<div class="page-container">
    <div class="text-center text-white">
        <h3>Finalizing login...</h3>
        <p>This should only take a moment.</p>
        <div class="spinner-border mt-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public string? Token { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Token))
        {
            var result = await ((ApiAuthenticationStateProvider)AuthStateProvider).LoginWithRefreshToken(Token);
            if (result)
            {
                NavigationManager.NavigateTo("/dashboard");
            }
            else
            {
                NavigationManager.NavigateTo("/authentication/login-failed");
            }
        }
        else
        {
            Console.WriteLine("FAILURE: 'token' query parameter NOT found");
            NavigationManager.NavigateTo("/authentication/token-missing");
        }
    }
}